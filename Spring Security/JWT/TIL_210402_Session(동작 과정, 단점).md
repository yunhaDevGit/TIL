# Session(동작 과정, 단점)

<img src="https://lh3.googleusercontent.com/h1so0dt60o5kNBQJIrtmvTrd6V7t0oXDHjG3kpK9vOm6SsPUcjrEUo-M912YzG6ZOkxMPLhjqfDw7zsqIKoT0EBTgT79-GV2WhgUHhl7K19EAN6io63ZxFazgfrfEMNmCDWpSdfkTxU" alt="img" style="zoom:80%;" />

**동작 과정**

1. 브라우저에서 서버에 최초 요청
2. 서버는 세션 목록에 세션 ID를 만들어준다.
3.  html을 리턴할 때, header에 세션 ID를 함께 보내준다
4. 두 번째 요청(세션 ID도 함께 보내준다)
5. 서버는 목록에 세션 ID가 있는지 확인 후, 없다면 새로 만든다. 



**세션은 언제 사라지나?**

1. 서버 쪽에서 Session 값을 날릴 때 : 목록에서 세션 ID를 지울 경우
2. 사용자가 브라우저를 다 종료시킬 경우
   - 서버의 세션 목록에 있는 값은 사라있지만 다시 접속 할 때, 세션 ID를 보내지 않기 때문에 서버 입장에서는 새롭다고 생각을 해서 새로운 세션 ID를 만들어준다.
3. 특정 시간이 지나면 세션 값이 서버 쪽에서 사라진다. 보통 30분



**세션**

- 로그인 요청을 할 때(인증을 위해) 주로 사용

  <img src="https://lh6.googleusercontent.com/oReiJKIHS55Rc8tum830MnZuQhIIygI0nYnjYjcJ-Ckz1USkP0oYlnDRJP33EoHOxt22549DON24IdJsKbgTB_QRJVwKDql7BpM8PrUVainXG3TuvQi1yiHoZNhXflj0lAuhDleuGGM" alt="img" style="zoom:80%;" />

1. 클라이언트가 최초 request

2. 서버는 세션이라는 저장소에 세션 ID를 만든다. 세션 ID가 들고 있는 작은 저장소가 생긴다.

   (세션 저장소는 엄청 크다. 다른 사용자 요청도 받아야 하므로...)

3. 서버가 응답을 해줄 때, header에 세션 ID를 담아 리턴해준다. 

4. 클라이언트(웹 브라우저)에 세션 ID가 저장된다.

5. 로그인 요청

6. 데이터베이스에서 해당 값이 있는지 확인

7. 정상일 경우, 데이터베이스에 있는 User 정보를 저장한다.

8. 메인 페이지를 리턴

9. 인증이 필요한 페이지 요청(사용자 정보 요청) - 세션 ID도 함께 보낸다

10. 세션 ID에 해당하는 것을 찾고, User 정보가 있는지 확인

11. 데이터베이스에 사용자 정보 요청

12. 데이터베이스에서 응답 받는다(사용자 정보)

13. 받은 정보 리턴



### 세션 단점

<img src="C:\Users\The Jeong\AppData\Roaming\Typora\typora-user-images\image-20210402170414426.png" alt="image-20210402170414426" style="zoom:80%;" />

클라이언트의 동시 접속자수가 많아 여러 서버에서 요청을 처리해야 할 경우 다루기 힘들다.

ex) 동시 접속자 수가 300명인데, 서버가 제공하는 동시 접속자 수가 100명일 경우, 서버를 여러대를 만들어서 요청을 처리해야 한다. 

클라이언트가 요청을 할 때, 각 서버에 로드밸런싱을 하는데, 첫 번째 요청에서는 두번째 서버에 요청을 했다고 하자. 그리고 다시 요청을 했을 때도 똑같이 두번째 서버에 요청을 보내면 상관 없는데, 로드밸런싱이 되어서 다른 서버에 요청을 보내면 해당 서버는 세션 정보가 없으니 최초 요청이라 인지하고 클라이언트에게 새로운 세션 ID를 반환해준다. 

클라이언트에게는 어이가 없는 상황...

**해당 문제를 해결하기 위한 방법**

_첫번째 방법_

sticky server를 만들어서 최초 요청을 받은 서버가 있다면, 두 번째 요청부터는 로드밸런싱 하지 않고 무조건 그 서버에 요청하도록 한다.

_두번째 방법_

세션을 모두에게 복제



***두 방법 모두 귀찮다***



_세번째 방법_

모든 서버들이 한 데이터베이스에 세션 정보를 넣어서 공유한다. 

-> 원래 세션은 서버가 들고 있는 메모리에 접근해서 정보를 가지고 오는 거라 엄청 빠르다. 근데 DB에서 가지고 오면 I/O가 발생한다. 즉, 매우 느려진다



:exclamation: ​_네번째 방법_

DB를 사용하지 않고 메모리 서버를 사용한다. 메모리 서버는 하드가 없이 메모리만 있다. 메모리에 세션 값을 저장하고 공유해서 사용한다. I/O 발생하지 않는다.

ex) 메모리 서버 : Redis

***가장 많이 사용하는 방법이다***